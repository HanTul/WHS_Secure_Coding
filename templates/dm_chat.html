{% extends "base.html" %}
{% block title %}{{ partner.username }}님과의 대화{% endblock %}

{% block head %}
  <script defer src="{{ url_for('static', filename='js/dm_chat.js') }}"></script>
  <meta name="room" content="{{ room }}">
  {% if product %}
    <meta name="item" content="{{ product.id }}">
  {% endif %}
{% endblock %}

{% block content %}
<h2 style="margin-bottom:12px;">{{ partner.username }} 님과의 대화</h2>

{% if product %}
  <div style="
      border:1px solid #ccc;
      padding:10px;
      margin-bottom:12px;
      display:flex;
      gap:10px;
      align-items:center;
      border-radius:8px;
      background:#fafafa;
    ">
    <img src="{{ product.image_path_list[0] }}"
         alt="상품 이미지"
         style="width:60px;height:60px;object-fit:cover;border-radius:6px;">
    <div>
      <h3>
        <a href="{{ url_for('product_detail', pid=product.id) }}" style="color: inherit; text-decoration: none;">
          {{ product.name }}
        </a>
      </h3>
      
      <div style="color:#888;">{{ '{:,}'.format(product.price) }}원</div>
    </div>
  </div>
{% endif %}

<div style="
    display:flex;
    flex-direction:column;
    height:70vh;  /* 적당히 줄인 높이 */
    overflow:hidden;
  ">
  <!-- 채팅 박스 -->
  <div id="chat-box" style="
      flex:1;
      min-height:0;
      overflow-y:auto;
      padding:10px;
      background:#f5f5f5;
      border:1px solid #ccc;
      border-radius:8px;
    ">
    {% for m in history %}
      <div class="message"
           data-time="{{ m.created_at.isoformat() }}Z"
           style="margin:6px 0;
                  text-align:{{ 'right' if m.sender_id==current_user.id else 'left' }};">
        <div style="
            display:inline-block;
            background:{{ '#cde0ff' if m.sender_id==current_user.id else '#eee' }};
            padding:8px 14px;
            border-radius:16px;
            max-width:70%;
            word-break:break-word;
          ">
          {{ m.content }}
        </div>
        <div class="msg-time" style="
            font-size:11px;
            color:#888;
            margin-top:4px;
          "></div>
      </div>
    {% endfor %}
  </div>

  <!-- 입력창 -->
  <input id="chat-input"
         placeholder="메시지를 입력하세요…"
         style="
           flex:none;
           width:100%;
           box-sizing:border-box;
           padding:12px;
           border:1px solid #ccc;
           border-radius:24px;
           outline:none;
           margin-top:10px;
         ">
</div>
{% endblock %}
